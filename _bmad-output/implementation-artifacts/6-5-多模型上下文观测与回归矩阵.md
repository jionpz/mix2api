# Story 6.5: 多模型上下文观测与回归矩阵

Status: done

## Story

As a 平台工程师,  
I want 观测上下文预算执行结果并建立多模型回归矩阵,  
so that 可以持续验证上下文管理策略在不同模型上的稳定性.

## Acceptance Criteria

1. **Given** 请求经过预算预检与上下文管理  
   **When** 记录指标与日志  
   **Then** 至少包含 `model`、`input_budget`、`output_budget`、`truncation_applied`、`reject_reason`  
   **And** 可按模型聚合查看触发率与失败率
2. **Given** 发布前执行回归  
   **When** 覆盖小窗口与大窗口模型场景  
   **Then** 上下文管理相关用例全部通过  
   **And** 失败样本可通过 `request_id` 追踪

## Tasks / Subtasks

- [x] 1. 预算观测字段补齐（AC: #1）
  - [x] 在预算决策后输出统一观测日志 `model.profile.budget_observation`
  - [x] 日志包含 `model`、`input_budget`、`output_budget`、`truncation_applied`、`reject_reason`
  - [x] 将预算观测字段同步到 `request.completed`，便于统一聚合
- [x] 2. request_id 追踪能力增强（AC: #2）
  - [x] 预算观测日志与 `request.completed` 统一携带请求上下文
  - [x] 验证失败样本可通过 `x-request-id` 在日志中定位
- [x] 3. 多模型回归矩阵（AC: #2）
  - [x] 增加小窗口模型（拒绝）+ 大窗口模型（通过）组合测试
  - [x] 验证预算观测字段在两类模型均正确输出并可区分
  - [x] 回归既有预算/裁剪/输出映射用例保持通过
- [x] 4. 文档补充
  - [x] 更新 README 说明预算观测字段和按模型聚合建议

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test --test-name-pattern "request\.completed logs fixed dimensions|budget observation logs with model-level fields" tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test --test-name-pattern "max_completion_tokens|max_tokens to upstream|max_tokens is invalid|default output budget for stream and non-stream|trims low-priority history|history summary memory block|budget observation logs with model-level fields" tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 中间件默认字段与 `request.completed` 增补预算观测维度：`model`、`input_budget`、`output_budget`、`truncation_applied`、`reject_reason`。
- 新增 `observeBudgetDecision`，统一写入 `model.profile.budget_observation` 日志，并同步 `res.locals` 供完成日志复用。
- 预算拒绝场景在执行二次上下文管理后，仍会输出最终预算观测与拒绝原因，支持故障聚合与复盘。
- 新增多模型矩阵测试：小窗口模型触发拒绝、大窗口模型通过，均可通过 `x-request-id` 在日志匹配对应预算观测记录。
- 全量回归通过，未引入功能回退。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `README.md`
- `_bmad-output/implementation-artifacts/6-5-多模型上下文观测与回归矩阵.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-24: 创建并实现 Story 6.5（预算观测字段补齐 + 多模型回归矩阵 + request_id 追踪验证），状态更新为 review。
- 2026-02-24: 代码评审通过，状态更新为 done。

## Senior Developer Review (AI)

### Review Date

2026-02-24

### Reviewer

Codex (GPT-5)

### Outcome

Approved

### Findings

- 无 High/Medium 问题；预算观测字段、模型维度聚合能力、request_id 追踪与多模型回归矩阵均满足验收要求。

### Test Evidence

- `node --test --test-name-pattern "request\\.completed logs fixed dimensions|budget observation logs with model-level fields" tests/integration/chat-completions-auth-nonstream.test.js`：`3 passed, 0 failed`
- `node --test --test-name-pattern "max_completion_tokens|max_tokens to upstream|max_tokens is invalid|default output budget for stream and non-stream|trims low-priority history|history summary memory block|budget observation logs with model-level fields" tests/integration/chat-completions-auth-nonstream.test.js`：`7 passed, 0 failed`
- `npm test`：`63 passed, 2 skipped, 0 failed`
