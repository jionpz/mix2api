# Epic 4 Retrospective: 工具闭环与 MCP-safe 兼容

## Epic Summary

- Epic: 4（工具闭环与 MCP-safe 兼容）
- Stories covered: 4.1, 4.2, 4.3, 4.4
- Completion status: 4/4 stories done, code review completed
- Core outcomes:
  - `tools` 与 legacy `functions/function_call` 入参兼容归一化
  - `tool_calls` 与 `tool_call_id` 唯一性与一致性保障
  - `tool` 回填后继续生成形成闭环
  - MCP-safe 工具保持透传且不触发服务端执行

## Team Participants

- Project Lead: 用户
- Developer: Codex (GPT-5)
- Reviewer: Senior Developer Review (AI workflow)

## Successes and Strengths

- 工具链路从“可调用”升级为“可闭环”，覆盖多工具与回填场景。
- `tool_call_id` 冲突去重逻辑提升了客户端执行确定性。
- MCP-safe 策略明确了服务边界，降低越权执行风险。
- 兼容层统一归一化后，legacy 与新协议可共存演进。

## Challenges and Growth Areas

- `tool_call_id` 跨重试/跨分段稳定策略仍可增强。
- tool backfill 当前采用较严格邻近校验，少数 SDK 兼容性有潜在张力。
- 非 function 工具当前默认忽略策略虽安全，但未来扩展需要更细治理方案。

## Key Insights and Learnings

- 工具链路稳定性的关键是“标识一致性 + 消息链完整性 + 执行边界明确”。
- 在协议混用时期，先做输入归一化是降低复杂度的最佳路径。
- 安全边界应在 MVP 阶段明确并以测试固化，避免后续语义漂移。

## Previous Retro Follow-through

- 来自 Epic 3 的“可归因可观察”能力已沿用到工具场景，关键路径可追踪性保持稳定。

## Next Epic Preview and Dependencies

- Next epic: Epic 5（观测治理与发布门禁）。
- Dependencies:
  - 工具链路指标需纳入发布门禁检查
  - 文档与回归包需覆盖工具闭环关键风险

## Action Items

- Owner: Developer
  - 评估将 `tool_call_id` 绑定到规范化参数哈希，增强跨重试稳定性。
- Owner: Developer
  - 评估放宽 backfill 校验为“向前查找最近 tool_calls”并配套告警。
- Owner: Project Lead
  - 在发布门禁中单列“tools-loop”稳定性观测项。

## Preparation Tasks for Next Phase

- 在文档层明确 MCP-safe 边界与非目标范围。
- 将 tools 相关回归纳入 A/B/C 门禁分组。
- 对工具调用错误口径进行一次统一复核。

## Critical Path and Discoveries

- Critical path:
  - 入参归一化正确
  - tool_call_id 唯一稳定
  - backfill 闭环可继续生成
  - MCP-safe 不越权执行
- Significant discoveries:
  - 兼容 legacy 的同时保持工具闭环可行且风险可控
  - 明确“不执行 MCP”边界能显著减少安全不确定性

## Readiness Assessment

- Epic objective achievement: Ready
- Tools-loop reliability: Ready
- MCP-safe boundary: Ready
- Residual risk: Low to Medium（主要在兼容性策略演进）

## Commitments and Next Steps

- Epic 4 retrospective completed.
- 后续将配合发布门禁持续监控 tools-loop 与兼容性回归。
