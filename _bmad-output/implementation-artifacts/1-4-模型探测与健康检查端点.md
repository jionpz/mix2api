# Story 1.4: 模型探测与健康检查端点

Status: done

## Story

As a 平台工程师,  
I want 提供可配置的模型列表与健康检查端点,  
so that 客户端探测与运维探活可稳定执行.

## Acceptance Criteria

1. **Given** 已配置模型清单  
   **When** 调用 `GET /v1/models`  
   **Then** 返回 OpenAI 兼容模型列表  
   **And** 配置变更可反映到返回内容
2. **Given** 服务正常运行  
   **When** 调用 `GET /health`  
   **Then** 返回健康状态  
   **And** 可用于容器/负载均衡探活

## Tasks / Subtasks

- [x] 1. 收敛 `/v1/models` 返回契约与配置解析（AC: #1）
  - [x] 保持 OpenAI 兼容返回结构（`object=list` + `data[]` + `id/object/created/owned_by`）
  - [x] 实现 `MODEL_LIST` 解析（支持逗号/换行分隔，过滤空值并去重）
  - [x] 当配置为空时回退默认模型清单
- [x] 2. 保持 `/health` 探活契约稳定（AC: #2）
  - [x] 维持 `GET /health` 返回 `status=ok` 的探活语义
  - [x] 保证响应头仍包含 `x-request-id` 以便排障关联
- [x] 3. 增加自动化回归覆盖（AC: #1 #2）
  - [x] 新增 `GET /v1/models` 默认模型列表测试
  - [x] 新增 `GET /v1/models` 配置生效测试
  - [x] 回归确认 `/health` 既有契约不回退

## Dev Notes

### Architectural Guardrails

- `GET /v1/models` 需保持 OpenAI 兼容模型列表形态，供 IDE/SDK 探测。  
  [Source: `_bmad-output/planning-artifacts/prd.md#Functional Requirements`]
- `GET /health` 是容器/负载均衡探活基础端点，要求语义稳定。  
  [Source: `_bmad-output/planning-artifacts/epics.md#Story 1.4: 模型探测与健康检查端点`]
- 服务返回 `x-request-id` 以支持链路排障关联。  
  [Source: `_bmad-output/planning-artifacts/prd.md#Non-Functional Requirements`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- `server.js` 已有 `/v1/models` 与 `/health` 路由；本 Story 以“契约收敛 + 测试补齐”为主，不引入重构。  
  [Source: `server.js`]
- 现有集成测试仅覆盖 `/health`，缺失模型探测端点与配置化场景自动化验证。  
  [Source: `tests/integration/health.test.js`]

### Testing Requirements

- 覆盖默认模型列表返回（无 `MODEL_LIST` 配置时）。
- 覆盖 `MODEL_LIST` 配置生效（含去重/空值过滤）。
- 覆盖 `/health` 基线行为不回退。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 1.4: 模型探测与健康检查端点`
- `_bmad-output/planning-artifacts/prd.md#Functional Requirements`
- `server.js`
- `tests/integration/health.test.js`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `npm test`

### Completion Notes List

- `/v1/models` 增加统一模型列表解析：支持 `MODEL_LIST` 逗号/换行分隔，过滤空值并去重。
- 保持 `/v1/models` OpenAI 兼容输出结构，并在配置缺失时回退默认模型列表。
- 新增集成测试覆盖默认模型列表与配置模型列表场景。
- 回归确认 `/health` 探活语义与 `x-request-id` 行为保持稳定。
- 执行 `npm test`，19/19 用例通过。

### File List

- `server.js`
- `tests/integration/health.test.js`
- `_bmad-output/implementation-artifacts/1-4-模型探测与健康检查端点.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-11: 实现 Story 1.4（模型探测与健康检查端点）：收敛 `MODEL_LIST` 配置解析与默认回退逻辑，补齐 `/v1/models` 集成测试并完成全量回归。
- 2026-02-11: 完成 Story 1.4 代码审查并通过，状态由 review 更新为 done。

## Senior Developer Review (AI)

### Review Date

2026-02-11

### Outcome

Approved (no blocking findings)

### Findings

- [LOW] 建议后续为 `MODEL_LIST` 增加“非法 JSON 串”输入的回归测试，以进一步提升配置容错可预测性。

### Verification

- `npm test` 通过（19/19）
