# Story 1.3: 流式开关路由与根路径兼容入口

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a AI 工程师,  
I want 在同一接口通过 `stream` 选择返回模式并可使用根路径兼容调用,  
so that 保持与现有 new-api/provider 调用方式一致.

## Acceptance Criteria

1. **Given** `stream` 分别为 `true` 与 `false`  
   **When** 调用 `POST /v1/chat/completions`  
   **Then** 服务进入对应处理分支  
   **And** 响应模式与请求参数一致
2. **Given** 调用 `POST /` 兼容入口  
   **When** 发送与 Chat Completions 等价请求  
   **Then** 行为与 `POST /v1/chat/completions` 等价  
   **And** 错误处理语义保持一致

## Tasks / Subtasks

- [x] 1. 固化 `stream` 参数分支行为（AC: #1）
  - [x] 明确并统一 `stream=true` 与 `stream=false` 的处理入口与分支条件，避免隐式分叉
  - [x] 确保流式分支返回 `text/event-stream` 且包含完整结束信号（`data: [DONE]`）
  - [x] 确保非流式分支稳定返回 OpenAI `chat.completion` 结构
- [x] 2. 落实根路径兼容入口与主入口等价语义（AC: #2）
  - [x] `POST /` 与 `POST /v1/chat/completions` 复用同一业务处理逻辑，避免双实现漂移
  - [x] 对成功路径、鉴权失败、入参错误场景保持一致的 HTTP status 与 error envelope
  - [x] 保持 `x-request-id` 在两个入口一致返回
- [x] 3. 收敛契约与回归风险（AC: #1 #2）
  - [x] 不改变已通过 Story 1.2 的鉴权和错误 envelope 语义
  - [x] 保证 `stream` 开关不破坏现有工具模式/会话逻辑（仅做入口与分支一致性改进）
  - [x] 对关键分支补充必要注释，减少后续故事（SSE 稳定化）改动冲突
- [x] 4. 增加自动化测试覆盖（AC: #1 #2）
  - [x] 新增集成测试：`/v1/chat/completions` 在 `stream=true|false` 下返回模式正确
  - [x] 新增集成测试：`POST /` 与 `/v1/chat/completions` 在等价请求下结果一致
  - [x] 新增集成测试：`POST /` 的鉴权失败/入参错误与主入口错误语义一致

## Dev Notes

### Architectural Guardrails

- 北向契约必须保持 OpenAI Chat Completions 语义：`POST /v1/chat/completions` 作为核心端点，`POST /` 作为兼容入口，二者行为需一致。  
  [Source: `_bmad-output/planning-artifacts/prd.md#Endpoint Specs`]
- 流式行为必须遵循 SSE 规范：`text/event-stream`、增量事件、最终 `data: [DONE]`。  
  [Source: `_bmad-output/planning-artifacts/prd.md#Data Schemas`]
- 错误语义必须维持 OpenAI error envelope（`error.message/type/code/param`）并与正确 HTTP status 对齐。  
  [Source: `_bmad-output/planning-artifacts/prd.md#Error Codes`]
- 结构边界要求：路由层仅做分发，不引入双份协议逻辑；协议语义保持统一出口。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Structure Patterns`]  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Architectural Boundaries`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 当前 `server.js` 已存在统一处理函数 `handleChatCompletion`，并同时挂载到 `POST /v1/chat/completions` 与 `POST /`；本故事重点应是“契约锁定 + 回归防护”，而非重写主流程。  
  [Source: `server.js`]
- 当前逻辑已包含 `clientWantsStream` 与上游 `upstreamRequest.stream` 分支，同时有流式 `data: [DONE]` 输出路径；实现时优先补齐稳定性与测试断言。  
  [Source: `server.js`]
- 现有测试基线使用 Node 内置 `node:test` 与 mock upstream 启动方式，新增测试应复用该模式，避免引入测试框架切换风险。  
  [Source: `tests/integration/chat-completions-auth-nonstream.test.js`]

### Previous Story Intelligence (Story 1.2)

- Story 1.2 已统一鉴权与基础入参校验，并引入 `sendOpenAIError` 作为错误 envelope 统一出口；Story 1.3 不应破坏该统一出口。  
  [Source: `_bmad-output/implementation-artifacts/1-2-入站鉴权与非流式-chat-completions-入口.md`]
- Story 1.2 已覆盖 `/v1/chat/completions` 非流式成功、401、400 与 malformed JSON 场景；Story 1.3 应在此基础上扩展 `stream` 与根路径等价覆盖。  
  [Source: `tests/integration/chat-completions-auth-nonstream.test.js`]

### Git Intelligence

- 当前仓库 `main` 分支尚无提交历史（`git log` 无记录），无法依赖 commit 轨迹提炼模式；本故事以现有工作区文件为唯一可信上下文。  
  [Source: `git log --oneline -n 8`]

### Testing Requirements

- 覆盖 AC #1：`/v1/chat/completions` 在 `stream=true` 时返回 SSE 语义，在 `stream=false` 时返回非流式 `chat.completion`。  
- 覆盖 AC #2：`POST /` 与 `POST /v1/chat/completions` 对等价请求返回等价行为（成功与失败都要覆盖）。  
- 回归要求：不得破坏 Story 1.2 已通过的鉴权/错误 envelope 用例。  
- 建议测试文件：`tests/integration/chat-completions-stream-root-compat.test.js`（或在现有集成测试文件中扩展）。  

### Project Structure Notes

- 短期允许在 `server.js` 内完成 Story 1.3 的行为收敛，以最小改动控制回归面。
- 中长期仍按架构演进到 `src/routes + src/controllers + src/services` 分层，本故事新增逻辑应保持可迁移边界。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Project Structure & Boundaries`]

### References

- `_bmad-output/planning-artifacts/epics.md#Story 1.3: 流式开关路由与根路径兼容入口`
- `_bmad-output/planning-artifacts/prd.md#Endpoint Specs`
- `_bmad-output/planning-artifacts/prd.md#Data Schemas`
- `_bmad-output/planning-artifacts/prd.md#Error Codes`
- `_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`
- `_bmad-output/planning-artifacts/architecture.md#Format Patterns`
- `_bmad-output/planning-artifacts/architecture.md#Project Structure & Boundaries`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `_bmad-output/implementation-artifacts/1-2-入站鉴权与非流式-chat-completions-入口.md`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 明确流式分支网关条件：仅在“客户端要求 stream 且上游实际返回 SSE”时走直通 SSE 转换，避免隐式分叉。
- 修复流式结束信号重复输出问题：上游已返回 `[DONE]` 时不再重复发送，保证结束语义稳定。
- 增强 `stream=true` 兼容性：当上游忽略 stream 并返回 JSON 时，仍保持北向 `text/event-stream` 输出并回放内容。
- 扩展集成测试覆盖：新增 `stream=true`、根路径成功/失败等价语义与请求头行为断言，保护 Story 1.2 的 401/400 契约不回退。
- 修复代码审查发现问题：无 session 元数据场景下流式 `[DONE]` 顺序错误、上游异常路径 error envelope 不一致、upstream keep-alive agent 每请求重建。
- 扩展回归测试：新增无 session 元数据流式顺序断言、上游 non-2xx 与业务错误的 OpenAI envelope 断言。
- 执行 `npm test`，17/17 用例通过。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `_bmad-output/implementation-artifacts/1-3-流式开关路由与根路径兼容入口.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-11: 实现 Story 1.3（流式开关路由与根路径兼容入口）：修复 stream 分支一致性与 `[DONE]` 结束信号重复问题，补充流式与根路径等价语义集成测试并全量通过。
- 2026-02-12: 依据代码审查结论修复高/中优先级问题：修正无 session 元数据时的 SSE `[DONE]` 发送顺序；统一上游异常为 OpenAI error envelope；将 upstream keep-alive agent 改为进程级复用；补充对应回归测试，Story 状态更新为 done。
