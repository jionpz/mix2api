# Story 6.2: 动态输入预算计算与请求前预检

Status: done

## Story

As a AI 工程师,  
I want 在请求进入上游前完成令牌预算预检,  
so that 不会因为模型输入上限差异导致随机超限失败.

## Acceptance Criteria

1. **Given** 请求包含 `messages`、可选 `tools` 与目标模型  
   **When** 服务进行预处理  
   **Then** 计算输入估算令牌与可用输入预算  
   **And** 为输出预留安全额度
2. **Given** 客户端请求的输出令牌过大  
   **When** 预算计算完成  
   **Then** 服务执行保护性裁剪或返回兼容错误  
   **And** 返回信息可用于调用方调整参数

## Tasks / Subtasks

- [x] 1. 建立统一预算预检计算入口（AC: #1 #2）
  - [x] 复用现有 `resolveModelProfile` 与估算函数，抽象预算计算结构（`estimated_input_tokens`、`reserved_output_tokens`、`available_input_tokens`）
  - [x] 明确输出预留策略（优先级：请求参数、模型画像默认值、安全下限）
  - [x] 统一预算决策结果（pass / clamp / reject）并保证流式与非流式共用同一逻辑
- [x] 2. 在请求链路执行请求前预检（AC: #1 #2）
  - [x] 在进入上游请求前完成预算决策，拒绝明显超预算请求
  - [x] 对“可裁剪”场景执行保护性处理，并保持 OpenAI 兼容错误 envelope
  - [x] 输出结构化预算日志（包含模型、输入估算、预算、决策与原因）
- [x] 3. 保持 API 兼容与回归稳定（AC: #2）
  - [x] 确保不改变 `/v1/chat/completions` 北向字段形态
  - [x] 对拒绝/裁剪场景给出可用于调用方调参的错误信息或日志归因
- [x] 4. 测试与回归（AC: #1 #2）
  - [x] 增加预算预检测试：messages+tools 组合预算、输入超预算拒绝、输出预留生效
  - [x] 增加请求参数测试：`max_tokens` / `max_completion_tokens` 大值下的保护行为
  - [x] 回归 stream/non-stream、`/v1/models`、现有工具调用闭环用例，避免回归
- [x] 5. 文档补充（AC: #1 #2）
  - [x] 更新 README/.env.example 中预算预检策略与关键配置说明
  - [x] 说明默认策略、裁剪策略与兼容错误语义

## Dev Notes

### Architectural Guardrails

- 预算预检属于请求预处理阶段，需保持“保护性并发/超时由 mix2api 承担、业务限流由 new-api 承担”的边界。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`]
- 入站请求体验证与错误返回必须保持 OpenAI 兼容 envelope。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Data Architecture`]
- 运行参数需保持外置配置能力，避免把预算阈值硬编码进实现。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Infrastructure & Deployment`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 已有模型画像与默认策略能力：`resolveModelProfile`、`buildModelProfileMap`，可直接复用作为预算上限来源。  
  [Source: `server.js`]
- 已有输入估算与输出上限保护基础已被收敛到统一决策函数：`resolveTokenBudgetDecision`。  
  [Source: `server.js`]
- 已有上下文裁剪与 query/messages 长度保护：`buildSafeQueryForUpstream`、`trimMessagesForUpstream`，已改为消费预算决策结果。  
  [Source: `server.js`]
- 现有集成测试框架已覆盖大量 chat 路径与回归场景，6.2 在同一文件补充预算预检用例。  
  [Source: `tests/integration/chat-completions-auth-nonstream.test.js`]

### Implementation Guidance

- 预算决策输出标准结构：
  - `estimatedInputTokens`
  - `reservedOutputTokens`
  - `availableInputTokens`
  - `action`
  - `reason`
- 预算日志字段标准化为：
  - `model.profile.input_budget`
  - `model.profile.output_budget`
- reject 场景返回兼容 `context_length_exceeded`，并提示调用方可减少 `messages/tools` 或降低 `max_tokens`。

### Testing Requirements

- 必测路径：
  - `messages + tools` 的输入估算与预算决策
  - 输入超预算拒绝且不上游（验证未触发 upstream 请求）
  - 输出预算过大时的裁剪或兼容错误
  - stream 与 non-stream 行为一致性
- 回归要求：
  - `npm test` 全量通过
  - 保持已有 auth/session/tools/stream 回归集不退化

### Project Structure Notes

- 当前实现仍以 `server.js` 单文件为主，本故事按现状增量实现，不要求拆分到 `src/` 分层。
- 新增预算函数放置在模型画像与请求预处理邻近区域，便于后续迁移拆分。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 6.2: 动态输入预算计算与请求前预检`
- `_bmad-output/planning-artifacts/architecture.md#Data Architecture`
- `_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`
- `_bmad-output/planning-artifacts/architecture.md#Infrastructure & Deployment`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `README.md`
- `.env.example`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test --test-name-pattern "model profile|max_completion_tokens|max_input_tokens|reserves output budget|tools payload|fallback warning cache|MODEL_LIST model without explicit profile" tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test --test-name-pattern "normalizes partial/invalid profile fields|reserves output budget|tools payload|max_completion_tokens|max_input_tokens" tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test --test-name-pattern "max_completion_tokens|reserves output budget before input check|prechecks transformed upstream payload|small available-input budgets" tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 新增统一预算决策函数 `resolveTokenBudgetDecision`，一次性产出输入估算、输出预留、可用输入预算与决策动作。
- 请求前预检升级为“预留输出预算后再比较 available_input_tokens”，并在超预算时返回兼容 `context_length_exceeded`。
- `convertToUpstreamFormat` 改为消费预算决策结果：上游 `max_tokens` 直接使用 `reserved_output_tokens`，query/system 字符预算基于 `available_input_tokens`。
- 输出预算默认预留新增配置 `TOKEN_BUDGET_DEFAULT_RESERVED_OUTPUT_TOKENS`（默认 1024），避免小窗口模型被默认输出预留挤占到不可用。
- 新增 2 条集成测试：输出预留挤占输入预算拒绝、tools 负载计入预算拒绝；并增强现有输出裁剪日志断言。
- 修复 code-review HIGH：预算预检改为基于最终 `upstreamRequest` 估算输入令牌，避免原始请求口径低估导致放过超预算请求。
- 修复 code-review MEDIUM：`action` 明确支持 `pass/clamp/reject`，输出裁剪场景输出 `action=clamp`。
- 修复 code-review MEDIUM：移除 `inputCharBudget` 的 1024 最小放大，严格跟随 `available_input_tokens * 4`。
- 新增 2 条集成测试：覆盖“变换后上游 payload 预检拒绝”与“小预算不放大”回归。
- 全量测试通过（57 passed, 2 skipped）。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `README.md`
- `.env.example`
- `_bmad-output/implementation-artifacts/6-2-动态输入预算计算与请求前预检.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-23: 创建 Story 6.2（ready-for-dev），补齐预算预检实现指导与测试约束。
- 2026-02-23: 实现 Story 6.2（预算预检决策、输出预留联动、请求前拒绝与回归测试），状态更新为 review。
- 2026-02-24: 修复 code-review 的 1 High + 2 Medium（预检口径统一、clamp 动作语义、小预算不放大），补充回归测试，状态更新为 review。
- 2026-02-24: Follow-up code-review 通过，状态更新为 done。

## Senior Developer Review (AI)

### Review Date

2026-02-23

### Reviewer

Codex (GPT-5)

### Outcome

Changes Requested（1 High, 2 Medium）

### Findings

- [HIGH] 预算预检估算口径与实际上游负载不一致，仍可能放过超预算请求。`estimateInputTokens` 仅基于原始 `messages/tools` 估算，但后续 `convertToUpstreamFormat` 会把历史再拼进 `query`，且保留 `messages`，导致上游实际输入可能明显高于预检口径。  
  [Evidence: `server.js:829`, `server.js:864`, `server.js:1843`, `server.js:1889`]
- [MEDIUM] `inputCharBudget` 采用 `Math.max(1024, availableInputTokens * 4)`，当可用输入预算很小时（<256 tokens）会强制放大到 1024 chars，破坏预算一致性并增加上游超限风险。  
  [Evidence: `server.js:1856`]
- [MEDIUM] Story 任务中声明预算决策支持 `pass/clamp/reject`，但当前实现只有 `pass/reject` 两态，`clamp` 仅体现在 reason 文本，不是明确 action，语义与任务声明不一致。  
  [Evidence: `server.js:952`, `server.js:955`, `_bmad-output/implementation-artifacts/6-2-动态输入预算计算与请求前预检.md:27`]

### Test Evidence

- `npm test`：`57 passed, 2 skipped, 0 failed`
- `node --test --test-name-pattern "max_completion_tokens|reserves output budget before input check|prechecks transformed upstream payload|small available-input budgets" tests/integration/chat-completions-auth-nonstream.test.js`：`4 passed, 0 failed`

## Code Review Fix Record (2026-02-24)

- [x] HIGH 已修复：预算预检改为基于最终 `upstreamRequest`（含 `request.query` + `messages` + `tools`）估算。
- [x] MEDIUM 已修复：预算 `action` 明确支持 `clamp`，并在输出裁剪时产生日志 `action=clamp reason=output_clamped`。
- [x] MEDIUM 已修复：`inputCharBudget` 改为 `available_input_tokens * 4`，不再使用 `Math.max(1024, ...)` 放大。

## Senior Developer Review (AI) - Follow-up

### Review Date

2026-02-24

### Reviewer

Codex (GPT-5)

### Outcome

Approved

### Findings

- 无新的 High/Medium 问题；前次 1 High + 2 Medium 修复闭环。

### Test Evidence

- `npm test`：`57 passed, 2 skipped, 0 failed`
