# Epic 3 Retrospective: 流式稳定与可归因排障

## Epic Summary

- Epic: 3（流式稳定与可归因排障）
- Stories covered: 3.1, 3.2, 3.3, 3.4
- Completion status: 4/4 stories done, code review completed
- Core outcomes:
  - `request_id` 生成、透传、回传、日志关联全链路贯通
  - SSE 首包及时性与 `[DONE]` 完成信号稳定
  - 流式终止分型（`timeout/upstream_error/client_abort/...`）可归因
  - 指标维度统一为 `client/stream/tools_present/end_reason/http_status/upstream_status`

## Team Participants

- Project Lead: 用户
- Developer: Codex (GPT-5)
- Reviewer: Senior Developer Review (AI workflow)

## Successes and Strengths

- 排障入口从“猜测”升级为“按 request_id 定位”，效率显著提升。
- 流式终止原因具备稳定枚举，发布决策与回滚判定有统一口径。
- 指标字段标准化后，可直接按客户端与模式做趋势分析。
- 流式首包延迟问题被专项修复并有自动化保障。

## Challenges and Growth Areas

- 历史日志格式仍有部分未完全统一，检索口径存在遗留差异。
- 流式异常断流的极端场景（如 reader error）仍可增加更细回归。
- 指标字段目前为代码约束，平台侧枚举看板约束还可加强。

## Key Insights and Learnings

- 网关可观测性建设应优先“字段稳定”而非“日志丰富”。
- `end_reason` 的语义一致性直接决定是否能安全做灰度判定。
- 流式体验核心不是吞吐，而是“首包可见 + 结束可判定 + 失败可归因”。

## Previous Retro Follow-through

- 来自 Epic 2 的稳定性目标得到延续：在不回退会话与鉴权能力前提下完成可归因观测升级。

## Next Epic Preview and Dependencies

- Next epic: Epic 4（工具闭环与 MCP-safe 兼容）。
- Dependencies:
  - 需要在已有流式与观测基础上引入工具调用闭环
  - 需要继续保持可归因字段在工具路径下不丢失

## Action Items

- Owner: Developer
  - 增加 `reader.on('error')` 断流场景的端到端分型回归。
- Owner: Developer
  - 补齐日志格式统一改造，尽量收敛到 `request.received/request.completed`。
- Owner: Project Lead
  - 在观测平台增加 `end_reason` 枚举漂移告警。

## Preparation Tasks for Next Phase

- 工具调用路径接入时同步携带既有指标维度。
- 定义工具场景下的失败分型优先级，避免归因冲突。
- 将 `client x stream` 聚合看板纳入发布前检查项。

## Critical Path and Discoveries

- Critical path:
  - request_id 全链路贯通
  - SSE 完成信号稳定
  - end_reason 口径统一
- Significant discoveries:
  - 无归因的流式稳定性问题几乎无法规模化运营
  - 固定维度指标比临时日志更能支撑决策

## Readiness Assessment

- Epic objective achievement: Ready
- Streaming reliability: Ready
- Observability quality: Ready
- Residual risk: Low to Medium

## Commitments and Next Steps

- Epic 3 retrospective completed.
- 后续将围绕工具链路继续强化流式归因与指标稳定性。
