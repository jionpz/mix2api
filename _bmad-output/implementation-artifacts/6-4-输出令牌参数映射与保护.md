# Story 6.4: 输出令牌参数映射与保护

Status: done

## Story

As a 平台工程师,  
I want 将客户端输出令牌参数按模型约束映射到上游并做边界保护,  
so that 不同模型都能得到可预测的输出长度与稳定行为.

## Acceptance Criteria

1. **Given** 请求包含 `max_tokens` 或 `max_completion_tokens`  
   **When** 服务构造上游请求  
   **Then** 按模型 `max_new_tokens` 上限进行映射与裁剪  
   **And** 不会把非法或超限值透传给上游
2. **Given** 请求未指定输出令牌参数  
   **When** 服务执行默认策略  
   **Then** 使用模型级默认输出预算  
   **And** 在流式与非流式下行为一致

## Tasks / Subtasks

- [x] 1. 输出参数映射与上限保护（AC: #1）
  - [x] 统一使用预算决策结果 `reserved_output_tokens` 作为上游 `max_tokens`
  - [x] 当请求值超出 `max_new_tokens` 时执行裁剪并记录 `model.profile.output_budget.clamped`
  - [x] 当请求值非法时不透传，回退到模型默认输出预算
- [x] 2. 默认输出预算策略（AC: #2）
  - [x] 未显式指定输出参数时使用 `TOKEN_BUDGET_DEFAULT_RESERVED_OUTPUT_TOKENS` 与模型上限共同决策
  - [x] 验证 stream/non-stream 在默认输出预算下行为一致
- [x] 3. 测试与文档
  - [x] 增加 `max_tokens` 映射与裁剪测试
  - [x] 增加 `max_tokens` 非法值回退默认预算测试
  - [x] 增加 stream/non-stream 默认输出预算一致性测试
  - [x] 更新 README 输出预算保护说明

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test --test-name-pattern "max_completion_tokens|max_tokens to upstream|invalid.*max_tokens|default output budget.*stream and non-stream" tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test --test-name-pattern "falls back to default reserved output budget when max_tokens is invalid" tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 复用既有 `resolveTokenBudgetDecision`，上游 `max_tokens` 统一来自 `reserved_output_tokens`。
- 补齐 `max_tokens` 参数的显式回归：超限裁剪到 `max_new_tokens`。
- 补齐非法 `max_tokens` 场景：记录 `output_budget.invalid`，并回退到默认输出预算。
- 补齐未指定输出参数时的 stream/non-stream 一致性验证。
- README 增补了非法值回退与流式一致性的行为说明。

### File List

- `tests/integration/chat-completions-auth-nonstream.test.js`
- `README.md`
- `_bmad-output/implementation-artifacts/6-4-输出令牌参数映射与保护.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-24: 创建并实现 Story 6.4（输出参数映射保护与回归补强），状态更新为 review。
- 2026-02-24: 代码评审通过，状态更新为 done。

## Senior Developer Review (AI)

### Review Date

2026-02-24

### Reviewer

Codex (GPT-5)

### Outcome

Approved

### Findings

- 无 High/Medium 问题；输出参数映射、非法值回退、stream/non-stream 一致性均满足验收要求。

### Test Evidence

- `node --test --test-name-pattern "max_completion_tokens|max_tokens to upstream|invalid.*max_tokens|default output budget.*stream and non-stream" tests/integration/chat-completions-auth-nonstream.test.js`：`3 passed, 0 failed`
- `node --test --test-name-pattern "falls back to default reserved output budget when max_tokens is invalid" tests/integration/chat-completions-auth-nonstream.test.js`：`1 passed, 0 failed`
- `npm test`：`62 passed, 2 skipped, 0 failed`
