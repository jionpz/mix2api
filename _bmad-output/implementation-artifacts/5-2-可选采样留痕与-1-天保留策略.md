# Story 5.2: 可选采样留痕与 1 天保留策略

Status: review

## Story

As a 平台工程师,  
I want 在需要时开启可选采样留痕并自动过期清理,  
so that 能复现复杂问题且控制数据暴露窗口.

## Acceptance Criteria

1. **Given** 默认配置  
   **When** 服务处理请求  
   **Then** 采样留痕关闭  
   **And** 不额外落盘敏感内容
2. **Given** 开启采样留痕  
   **When** 命中采样策略  
   **Then** 仅记录脱敏后的必要样本  
   **And** 样本在 1 天后自动删除

## Tasks / Subtasks

- [x] 1. 可选采样留痕机制（AC: #1 #2）
  - [x] 新增 `TRACE_SAMPLING_ENABLED/TRACE_SAMPLING_RATE` 配置，默认关闭
  - [x] 命中采样时仅记录最小结构化样本（不记录 prompts/tool payload 原文）
  - [x] 样本条目支持容量上限控制（`TRACE_MAX_ENTRIES`）
- [x] 2. 1 天保留与自动清理（AC: #2）
  - [x] 新增 `TRACE_RETENTION_MS`（默认 24h）
  - [x] 新增定时清理任务（`TRACE_CLEANUP_INTERVAL_MS`）按过期时间自动删除
  - [x] 清理事件输出结构化日志（`trace.purged`）
- [x] 3. 自动化回归（AC: #1 #2）
  - [x] 新增“默认关闭”测试（无 `trace.sampled`）
  - [x] 新增“开启采样 + 短 TTL 自动清理”测试（`trace.sampled` + `trace.purged`）
  - [x] 全量回归通过

## Dev Notes

### Architectural Guardrails

- 采样留痕必须是可选能力，默认关闭；启用后仅记录最小必要且脱敏后的样本。  
  [Source: `_bmad-output/planning-artifacts/epics.md#Story 5.2: 可选采样留痕与 1 天保留策略`]
- 保留策略默认 1 天并自动删除，避免长期暴露窗口。  
  [Source: `_bmad-output/planning-artifacts/epics.md#Story 5.2: 可选采样留痕与 1 天保留策略`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 现有请求日志已具备脱敏和结构化维度，可复用同一日志上下文做采样留痕。  
  [Source: `server.js`]
- 现有集成测试框架支持抓取子进程日志，适合验证采样与清理行为。  
  [Source: `tests/integration/chat-completions-auth-nonstream.test.js`]

### Testing Requirements

- 验证默认配置下不产生采样留痕日志。
- 验证启用采样并命中后生成样本，且在过期后自动清理。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 5.2: 可选采样留痕与 1 天保留策略`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test`

### Completion Notes List

- 新增可选采样留痕：默认关闭，启用后按采样率记录最小结构化字段。
- 新增样本 TTL 与定时清理，默认保留 24 小时。
- 新增 2 条集成测试覆盖“默认关闭”和“自动过期清理”。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `_bmad-output/implementation-artifacts/5-2-可选采样留痕与-1-天保留策略.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-11: 实现 Story 5.2（可选采样留痕与 1 天保留策略）：新增采样留痕、自动清理与回归测试。
