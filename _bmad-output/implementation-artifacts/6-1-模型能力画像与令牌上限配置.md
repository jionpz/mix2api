# Story 6.1: 模型能力画像与令牌上限配置

Status: done

## Story

As a 平台工程师,  
I want 为每个模型维护 context window、最大输入令牌、最大新令牌的统一配置,  
so that 系统可以基于模型差异执行一致的上下文预算决策.

## Acceptance Criteria

1. **Given** 已配置多个模型能力画像  
   **When** 服务接收对应模型请求  
   **Then** 能读取该模型的 `context_window`、`max_input_tokens`、`max_new_tokens`  
   **And** 未配置模型走保守默认值并输出告警事件
2. **Given** 配置被更新  
   **When** 服务重新加载配置  
   **Then** 新请求按新约束执行预算  
   **And** 不影响既有 API 契约形态

## Tasks / Subtasks

- [x] 1. 设计模型能力画像配置结构与校验逻辑（AC: #1 #2）
  - [x] 定义模型能力画像字段：`context_window`、`max_input_tokens`、`max_new_tokens`
  - [x] 在现有配置入口增加模型画像配置读取（建议环境变量 JSON），并补齐默认值策略
  - [x] 增加无效配置与未知模型的降级路径（保守默认值 + 告警日志）
- [x] 2. 在请求链路接入模型画像解析（AC: #1）
  - [x] 基于请求 `model` 解析并挂载能力画像（供后续预算与裁剪故事复用）
  - [x] 保持现有北向响应结构不变，不新增破坏性字段
  - [x] 确保流式与非流式路径均可访问同一模型画像结果
- [x] 3. 兼容已有模型配置能力（AC: #1 #2）
  - [x] 复用现有模型列表解析能力（`MODEL_LIST`）并与画像配置联动
  - [x] 未配置画像但在模型列表中的模型，使用默认画像并明确记录告警
- [x] 4. 测试与回归（AC: #1 #2）
  - [x] 增加配置解析测试：合法配置、缺省字段、非法值、未知模型降级
  - [x] 增加请求路径测试：不同模型选择不同画像，且不影响既有接口语义
  - [x] 回归 `GET /v1/models` 现有行为，避免引入回归
- [x] 5. 文档补充（AC: #2）
  - [x] 更新 `.env.example` 与 README 的配置说明（画像字段含义、默认值、更新方式）

## Dev Notes

### Architectural Guardrails

- 当前架构要求“运行参数可配置并可在不改代码情况下调整”，模型画像配置需遵循同一原则。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Infrastructure & Deployment`]
- 会话隔离 key 已包含 `model` 维度，模型画像解析应保持与该维度一致，避免跨模型复用错误。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#Data Architecture`]
- 兼容优先，不得破坏北向 OpenAI Chat Completions 契约。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 当前仓库已有模型列表配置能力：`MODEL_LIST` + `parseModelList` + `resolveModelIds`，应在其基础上扩展画像能力，而非重写模型配置体系。  
  [Source: `server.js`]
- 当前上下文/裁剪逻辑已有多组阈值配置（如 `CONTEXT_MAX_*`、`UPSTREAM_MESSAGES_MAX`），6.1 应先把模型能力画像抽象为统一输入，再供后续 6.2/6.3 消费。  
  [Source: `server.js`]
- 现有集成测试已覆盖 `MODEL_LIST` 行为，新增实现不能破坏既有 `/v1/models` 输出。  
  [Source: `tests/integration/health.test.js`]

### Implementation Guidance

- 建议先实现轻量解析器（例如 `resolveModelProfile(model)`），返回规范化对象：
  - `contextWindow`
  - `maxInputTokens`
  - `maxNewTokens`
  - `source`（configured/default）
- 建议先在 `server.js` 内增量落地，后续故事再按架构目标逐步拆分到 `services/session|chat|config` 等模块。
- 模型标识归一化应复用现有 `normalizeModelSlug` 思路，避免同模型多别名导致画像命中失败。

### Testing Requirements

- 必测路径：
  - 已配置模型命中画像
  - 未配置模型回退默认画像并告警
  - 配置热更新后新请求生效
  - `/v1/models` 与 chat 请求路径行为无回归
- 测试优先级：先单测配置解析，再集成测试请求路径。

### Project Structure Notes

- 架构文档目标结构是 `src/` 分层，但当前实际实现仍以 `server.js` 为主；本故事允许按现状增量实现，避免一次性重构引入风险。
- 新增能力需保持命名与日志字段一致性，便于后续 6.5 观测故事直接接入。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 6.1: 模型能力画像与令牌上限配置`
- `_bmad-output/planning-artifacts/epics.md#Story 6.2: 动态输入预算计算与请求前预检`
- `_bmad-output/planning-artifacts/architecture.md#Data Architecture`
- `_bmad-output/planning-artifacts/architecture.md#API & Communication Patterns`
- `server.js`
- `.env.example`
- `tests/integration/health.test.js`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test --test-name-pattern "model profile" tests/integration/chat-completions-auth-nonstream.test.js`
- `node --test --test-name-pattern "model profile|max_completion_tokens|max_input_tokens|fallback warning cache|MODEL_LIST model without explicit profile" tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 新增模型能力画像配置能力：支持 `MODEL_PROFILE_JSON`、默认画像参数和配置合法性修正。
- 请求处理链路新增 `resolveModelProfile(model)` 解析，并输出结构化日志 `model.profile` 便于后续预算故事复用。
- 未配置模型时回退默认画像并输出 `model.profile.fallback` 告警。
- 新增 3 条集成测试覆盖：配置命中、未知模型降级、重启后配置生效。
- 根据代码审查补充：将模型画像接入输入预算预检与输出令牌上限映射，并加入 `MODEL_LIST` 默认画像联动。
- 根据代码审查补充：为 fallback 告警去重缓存增加容量上限，避免未知模型持续增长导致内存占用无界。
- 新增集成测试覆盖：`MODEL_LIST` 联动默认画像、非法配置归一化、输入超预算拦截、输出令牌裁剪、fallback 告警缓存上限。
- 全量测试通过（53 passed, 2 skipped）。

### File List

- `_bmad-output/implementation-artifacts/6-1-模型能力画像与令牌上限配置.md`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `.env.example`
- `README.md`
- `_bmad-output/planning-artifacts/epics.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-24: 实现 Story 6.1（模型能力画像与令牌上限配置），新增配置解析、降级告警、集成测试与文档说明。
- 2026-02-24: 根据 code-review 结果补齐预算执行链路、`MODEL_LIST` 联动、fallback 缓存上限与回归测试覆盖。
- 2026-02-23: 二次 code-review 复审通过，状态更新为 done，并同步 sprint-status。

## Senior Developer Review (AI)

### Review Date

2026-02-23

### Reviewer

Codex (GPT-5)

### Outcome

Approve（No HIGH/MEDIUM findings）

### Validation Summary

- AC#1 已覆盖：可按模型读取 `context_window`/`max_input_tokens`/`max_new_tokens`；未知模型与 MODEL_LIST 默认画像均可回退并记录告警。
- AC#2 已覆盖：重启加载新配置后，新请求按新预算执行；北向 OpenAI 契约保持不变。
- 先前 review 指出的 HIGH/MEDIUM 缺口已关闭：预算执行接入、MODEL_LIST 联动、非法/缺省配置测试、fallback 告警缓存有界化。

### Test Evidence

- `node --test --test-name-pattern "model profile|max_completion_tokens|max_input_tokens|fallback warning cache|MODEL_LIST model without explicit profile" tests/integration/chat-completions-auth-nonstream.test.js` ✅
- `npm test` → `53 passed, 2 skipped, 0 failed` ✅

### Residual Risk (Non-blocking)

- 输入预算使用字符数近似估算 token（`chars/4`），在极端语言分布下可能与真实 tokenizer 存在偏差；建议在 Story 6.2/6.5 引入模型级 tokenizer 精算与观测校准。
