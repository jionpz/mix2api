# Story 2.3: 自动会话创建与上游会话复用

Status: review

## Story

As a AI 工程师,  
I want 在未显式提供 session 时自动建立并复用上游会话,  
so that OpenCode/Claude Code 多轮对话保持连续.

## Acceptance Criteria

1. **Given** 首次请求未提供 session  
   **When** 调用 Chat Completions  
   **Then** 服务自动创建上游会话并保存关联信息  
   **And** 后续请求可命中同一会话
2. **Given** 已存在可复用的 session 映射  
   **When** 处理后续对话  
   **Then** 使用已有上游 `sessionId/exchangeId`  
   **And** 不重复创建新会话

## Tasks / Subtasks

- [x] 1. 自动会话创建与映射写入（AC: #1）
  - [x] 无显式 `session_id` 时从上游响应自动提取 `sessionId/exchangeId`
  - [x] 将会话映射写入本地 session store
- [x] 2. 会话映射复用（AC: #2）
  - [x] 后续请求命中映射时自动补全 `session_id`
  - [x] 后续请求命中映射时自动补全 `exchange_id`
  - [x] 维护会话更新逻辑，避免 `exchangeId` 在缺失响应中被意外清空
- [x] 3. 自动化回归（AC: #1 #2）
  - [x] 扩展集成测试，验证复用 `session_id + exchange_id`
  - [x] 全量回归通过

## Dev Notes

### Architectural Guardrails

- 未显式提供 session 时，适配器应自动建立并复用会话，保障多轮连续性。  
  [Source: `_bmad-output/planning-artifacts/epics.md#Story 2.3: 自动会话创建与上游会话复用`]
- 会话相关状态需最小化维护且行为稳定，可用于后续 Redis 化扩展。  
  [Source: `_bmad-output/planning-artifacts/architecture.md#State Management Patterns`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 现有代码已支持 `session_id` 自动复用，本 Story聚焦补齐 `exchange_id` 复用与状态保持。  
  [Source: `server.js`]
- 既有集成测试覆盖了 `session_id` 自动复用，但未断言 `exchange_id` 复用。  
  [Source: `tests/integration/chat-completions-auth-nonstream.test.js`]

### Testing Requirements

- 覆盖自动会话建立后，后续请求携带 `session_id`。
- 覆盖自动会话建立后，后续请求携带 `exchange_id`。
- 全量回归通过。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 2.3: 自动会话创建与上游会话复用`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `npm test`

### Completion Notes List

- 在会话自动复用流程中新增 `exchange_id` 的读取、传递与复用。
- 调整 session store 更新逻辑：当上游响应未返回 `exchangeId` 时，保留同会话已存 `exchangeId`。
- 扩展集成测试断言，验证后续请求复用 `session_id + exchange_id`。
- 回归测试全部通过。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `_bmad-output/implementation-artifacts/2-3-自动会话创建与上游会话复用.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-11: 实现 Story 2.3（自动会话创建与上游会话复用）：补齐 `exchange_id` 复用链路并增强会话状态保持与回归测试。
