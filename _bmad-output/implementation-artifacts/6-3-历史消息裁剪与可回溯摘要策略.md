# Story 6.3: 历史消息裁剪与可回溯摘要策略

Status: done

## Story

As a AI 工程师,  
I want 在超预算时按优先级裁剪历史上下文并可选摘要压缩,  
so that 在不同模型窗口下仍能保持对话连续性与关键语义.

## Acceptance Criteria

1. **Given** 请求输入估算超出模型可用输入预算  
   **When** 触发上下文管理策略  
   **Then** 保留 `system` 与最新轮次关键消息  
   **And** 按策略裁剪较早低价值历史消息
2. **Given** 裁剪后仍接近上限  
   **When** 摘要策略开启  
   **Then** 服务将被裁剪历史压缩为短摘要记忆块  
   **And** 在观测中记录裁剪与摘要触发信息

## Tasks / Subtasks

- [x] 1. 增加超预算后的二次上下文管理入口（AC: #1 #2）
  - [x] 在首次预算预检 `reject` 后触发二次构造，而非立即拒绝
  - [x] 二次构造保持 `system` + 最近关键消息，优先裁剪早期低价值历史
  - [x] 二次构造完成后重新执行预算决策并复用既有拒绝语义
- [x] 2. 实现可选摘要记忆块（AC: #2）
  - [x] 提供环境变量开关控制摘要策略启停
  - [x] 将被裁剪历史压缩为短摘要块并注入 query（`[历史摘要记忆]`）
  - [x] 限制摘要长度与行数，避免再次挤占预算
- [x] 3. 观测与日志（AC: #2）
  - [x] 记录结构化日志 `model.profile.context_management`
  - [x] 日志包含 `truncation_applied`、`summary_applied`、`dropped_messages`、`kept_messages`
- [x] 4. 测试与文档
  - [x] 新增“超预算触发裁剪后可恢复通过”集成测试
  - [x] 新增“摘要记忆块注入与日志观测”集成测试
  - [x] 更新 `.env.example` 与 `README.md` 说明

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test --test-name-pattern "max_completion_tokens|reserves output budget before input check|prechecks transformed upstream payload|small available-input budgets|trims low-priority history|history summary memory block" tests/integration/chat-completions-auth-nonstream.test.js`
- `npm test`

### Completion Notes List

- 新增预算恢复函数：首次预算预检 `reject` 时，触发二次上下文管理（历史裁剪）后重新评估预算。
- 新增历史裁剪策略：保留首条 `system` 与最近关键消息，优先丢弃较早消息；避免在 tool 链中间截断。
- 新增可选摘要策略：`BUDGET_HISTORY_SUMMARY_ENABLED=true` 时，把被裁剪历史压缩为短摘要并注入 query 的 `[历史摘要记忆]` 段。
- 新增上下文管理结构化日志：`model.profile.context_management`，记录裁剪与摘要触发信息。
- 增加 2 条集成测试覆盖 Story 6.3 核心路径；并确保 6.2 预算相关测试继续通过。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `README.md`
- `.env.example`
- `_bmad-output/implementation-artifacts/6-3-历史消息裁剪与可回溯摘要策略.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-24: 创建并实现 Story 6.3（超预算二次上下文管理 + 可选摘要记忆块 + 观测日志 + 回归测试），状态更新为 review。
- 2026-02-24: 代码评审通过，状态更新为 done。

## Senior Developer Review (AI)

### Review Date

2026-02-24

### Reviewer

Codex (GPT-5)

### Outcome

Approved

### Findings

- 无 High/Medium 风险发现；实现满足 Story 6.3 的验收要点（超预算二次裁剪、可选摘要、可观测性）。

### Test Evidence

- `node --test --test-name-pattern "max_completion_tokens|reserves output budget before input check|prechecks transformed upstream payload|small available-input budgets|trims low-priority history|history summary memory block" tests/integration/chat-completions-auth-nonstream.test.js`：`6 passed, 0 failed`
- `npm test`：`59 passed, 2 skipped, 0 failed`
