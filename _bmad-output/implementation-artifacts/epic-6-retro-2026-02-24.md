# Epic 6 Retrospective: 多模型上下文管理与令牌预算自适配

## Epic Summary

- Epic: 6（多模型上下文管理与令牌预算自适配）
- Stories covered: 6.1, 6.2, 6.3, 6.4, 6.5
- Completion status: 5/5 stories done, all reviews approved
- Sprint evidence:
  - 模型能力画像与默认回退策略已配置化生效
  - 请求前预算预检支持输出预留、输入预算决策与兼容拒绝语义
  - 超预算二次上下文管理（历史裁剪 + 可选摘要记忆块）已落地
  - 输出参数映射保护（`max_tokens` / `max_completion_tokens`）在 stream/non-stream 一致
  - 预算观测字段已统一输出并可按模型聚合，失败样本可通过 `x-request-id` 追踪

## Team Participants

- Product/Project Lead: 用户
- Developer: Codex (GPT-5)
- Reviewer: Senior Developer Review (AI workflow)

## Successes and Strengths

- 预算策略从“单次估算”升级到“最终上游 payload 口径”，显著降低误放过超预算请求风险。
- 上下文管理具备二次恢复能力，优先保留关键消息，减少直接拒绝带来的可用性损失。
- 输出令牌保护策略在参数合法、超限、非法和缺省场景均有稳定行为与回归覆盖。
- 观测字段与完成日志统一，形成了模型维度预算运营闭环（预算、裁剪、拒绝原因可追踪）。
- Epic 6 全程保持全量回归通过，未引入既有 stream/tools/session 路径回退。

## Challenges and Growth Areas

- 当前 token 估算仍是字符近似换算，跨语言与结构化 payload 的估算精度可继续提升。
- 历史摘要当前为规则压缩文本，尚未引入语义级摘要质量评估。
- 预算观测目前以日志聚合为主，后续可考虑接入统一指标系统与告警阈值。
- 多模型矩阵目前以代表性小/大窗口模型覆盖，仍可扩大到更多真实生产模型组合。

## Key Insights and Learnings

- “先统一决策口径，再扩展恢复策略”是处理预算稳定性的正确顺序。
- 二次上下文管理应与可观测字段同步设计，否则难以支撑线上归因。
- 输出参数兼容不只是映射问题，还需要覆盖非法值与缺省策略的一致行为。
- 回归矩阵要覆盖正负路径（通过+拒绝）并保留 request_id，才能形成可复盘证据链。

## Previous Retro Follow-through

- Epic 5 的门禁化与最小日志治理策略在 Epic 6 继续发挥作用：
  - 预算功能迭代全程依赖回归门禁保障无回退。
  - 预算观测字段延续结构化日志风格，便于统一运维检索。

## Next Epic Preview and Dependencies

- Epic 6 已完成，建议进入发布收敛阶段（release-readiness）。
- 关键依赖：
  - 继续执行回归门禁（A/B/C + 多模型预算用例）
  - 持续校验文档与配置说明与实现一致
  - 规划预算观测指标化与阈值告警（运营阶段）

## Action Items

- Owner: Developer
  - 评估并设计更高精度 token 估算方案（按模型 tokenizer 或可插拔估算器）。
- Owner: Developer
  - 评估历史摘要策略的语义质量改进路径（规则压缩 -> 语义摘要）。
- Owner: Project Lead
  - 在发布前纳入多模型预算矩阵结果作为放量检查项。
- Owner: Developer + Project Lead
  - 规划预算观测字段的指标化接入与告警阈值（按模型、按拒绝原因）。

## Preparation Tasks for Next Phase

- 生成本轮 release-readiness 交接记录（含预算功能测试证据与风险清单）。
- 固化多模型预算矩阵为稳定门禁集合，减少测试名匹配漂移风险。
- 针对最小窗口模型准备压测样本，验证拒绝与恢复策略在高负载下的稳定性。

## Critical Path and Discoveries

- Critical path:
  - 统一预算决策与映射逻辑
  - 上下文恢复策略落地
  - 预算观测字段闭环
  - 全量回归持续通过
- Significant discoveries:
  - 预检口径必须基于最终上游请求形态，否则存在系统性低估。
  - 裁剪策略必须与 tool 链路结构一致，避免破坏工具回填闭环。

## Readiness Assessment

- Implementation readiness: Ready
- Operational readiness: Ready（基于预算观测与回归结果）
- Documentation readiness: Ready
- Follow-up risk level: Medium（主要在估算精度与摘要语义质量）

## Commitments and Next Steps

- Epic 6 retrospective completed.
- `epic-6-retrospective` 标记为 `done`。
- 下一步进入 release-readiness 收敛与发布门禁复核。
