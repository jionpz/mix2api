# Story 5.1: 最小日志策略与字段级脱敏

Status: review

## Story

As a 平台工程师,  
I want 默认只记录必要结构化字段并对敏感字段脱敏,  
so that 排障可用且不会泄露鉴权或会话敏感信息.

## Acceptance Criteria

1. **Given** 请求成功或失败  
   **When** 服务记录日志  
   **Then** 默认不持久化 prompts/tool payload 原文  
   **And** 保留最小观测字段用于统计
2. **Given** 日志中出现 Authorization/cookie/token/session 等字段  
   **When** 脱敏规则生效  
   **Then** 输出为脱敏值或摘要  
   **And** 不出现明文敏感数据

## Tasks / Subtasks

- [x] 1. 默认日志收敛（AC: #1）
  - [x] 上游响应体/解析细节日志默认关闭（仅在 `LOG_BODIES=true` 时输出）
  - [x] 会话相关日志输出使用指纹（fp），避免明文 session/exchange id
- [x] 2. 字段级脱敏（AC: #2）
  - [x] `redactHeaders()` 覆盖 authorization/cookie/token/session 等敏感 header
  - [x] `redactSensitiveText()` 覆盖 token/session/exchange 字段的 JSON 场景
- [x] 3. 自动化回归（AC: #1 #2）
  - [x] 新增集成测试：`LOG_HEADERS=true` 时 authorization/cookie/session 不出现在日志中
  - [x] 回归通过

## Dev Notes

### Architectural Guardrails

- 默认不持久化 prompts/tool payload，日志仅保留最小观测字段，敏感字段必须脱敏。  
  [Source: `_bmad-output/planning-artifacts/epics.md#Story 5.1: 最小日志策略与字段级脱敏`]

### Current Repo Reality Check (Do Not Reinvent Wheels)

- 现有已具备 `LOG_HEADERS/LOG_BODIES` 开关与基础脱敏，但仍存在部分上游响应/会话信息的默认明文输出。  
  [Source: `server.js`]

### Testing Requirements

- 覆盖 `LOG_HEADERS=true` 场景，验证 authorization/cookie/session 不出现在日志中。

### References

- `_bmad-output/planning-artifacts/epics.md#Story 5.1: 最小日志策略与字段级脱敏`
- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`

## Dev Agent Record

### Agent Model Used

GPT-5 (Codex)

### Debug Log References

- `node --test tests/integration/chat-completions-auth-nonstream.test.js`

### Completion Notes List

- 默认关闭上游响应体/解析细节日志，仅在 `LOG_BODIES=true` 时输出。
- 扩展 header/text 脱敏逻辑，覆盖 authorization/cookie/token/session。
- 会话相关日志改为输出指纹，避免明文泄露。
- 新增集成回归验证日志脱敏。

### File List

- `server.js`
- `tests/integration/chat-completions-auth-nonstream.test.js`
- `_bmad-output/implementation-artifacts/5-1-最小日志策略与字段级脱敏.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`
- `_bmad-output/workflow-status.yaml`

### Change Log

- 2026-02-11: 实现 Story 5.1（最小日志策略与字段级脱敏）：收敛默认日志并补齐字段级脱敏与回归测试。
