openapi: 3.0.3
info:
  title: mix2api OpenAI-Compatible API
  version: 0.1.0
  description: |
    OpenAI Chat Completions compatible adapter API.
    Supports streaming SSE, tools/legacy functions compatibility, and OpenAI-style error envelope.
servers:
  - url: http://localhost:3001
tags:
  - name: Health
  - name: Models
  - name: Chat
paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      operationId: getHealth
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
              example:
                status: ok
                service: mix2api

  /v1/models:
    get:
      tags: [Models]
      summary: List available models
      operationId: listModels
      responses:
        "200":
          description: OpenAI-compatible model list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModelListResponse"
              example:
                object: list
                data:
                  - id: mix/qwen-3-235b-instruct
                    object: model
                    created: 1739200000
                    owned_by: mix2api
                  - id: mix/claude-sonnet-4-5
                    object: model
                    created: 1739200000
                    owned_by: mix2api

  /v1/chat/completions:
    post:
      tags: [Chat]
      summary: Create chat completion (streaming or non-streaming)
      operationId: createChatCompletion
      parameters:
        - in: header
          name: Authorization
          required: false
          schema:
            type: string
          description: Bearer token, required when INBOUND_AUTH_MODE=bearer.
        - in: header
          name: x-request-id
          required: false
          schema:
            type: string
          description: Optional request correlation id. Invalid value will be regenerated.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatCompletionRequest"
            examples:
              non_stream:
                value:
                  model: mix/qwen-3-235b-instruct
                  stream: false
                  messages:
                    - role: user
                      content: hello
              stream:
                value:
                  model: mix/qwen-3-235b-instruct
                  stream: true
                  messages:
                    - role: user
                      content: hello stream
              tools:
                value:
                  model: mix/qwen-3-235b-instruct
                  stream: false
                  tools:
                    - type: function
                      function:
                        name: read_file
                        description: Read file content
                        parameters:
                          type: object
                          properties:
                            path:
                              type: string
                          required: [path]
                  messages:
                    - role: user
                      content: read README.md
              legacy_functions:
                value:
                  model: mix/qwen-3-235b-instruct
                  stream: false
                  functions:
                    - name: get_weather
                      description: Query weather by city
                      parameters:
                        type: object
                        properties:
                          city:
                            type: string
                        required: [city]
                  function_call:
                    name: get_weather
                  messages:
                    - role: user
                      content: weather in Shanghai
      responses:
        "200":
          description: |
            Success.
            - `application/json` when stream=false
            - `text/event-stream` when stream=true
          headers:
            x-request-id:
              schema:
                type: string
              description: Request correlation id generated or echoed by server.
            x-session-id:
              schema:
                type: string
              description: Optional upstream session id propagated by adapter.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatCompletionResponse"
              examples:
                text_completion:
                  value:
                    id: chatcmpl-123
                    object: chat.completion
                    created: 1739200000
                    model: mix/qwen-3-235b-instruct
                    choices:
                      - index: 0
                        message:
                          role: assistant
                          content: mocked upstream answer
                        finish_reason: stop
                    usage:
                      prompt_tokens: 0
                      completion_tokens: 0
                      total_tokens: 0
                tool_calls_completion:
                  value:
                    id: chatcmpl-456
                    object: chat.completion
                    created: 1739200000
                    model: mix/qwen-3-235b-instruct
                    choices:
                      - index: 0
                        message:
                          role: assistant
                          content: null
                          tool_calls:
                            - id: call_abcd1234
                              type: function
                              function:
                                name: read_file
                                arguments: "{\"path\":\"README.md\"}"
                        finish_reason: tool_calls
                    usage:
                      prompt_tokens: 0
                      completion_tokens: 0
                      total_tokens: 0
            text/event-stream:
              schema:
                type: string
              example: |
                data: {"id":"chatcmpl-abc","object":"chat.completion.chunk","created":1739200000,"model":"mix/qwen-3-235b-instruct","choices":[{"index":0,"delta":{"role":"assistant","content":"hello"},"finish_reason":null}]}

                data: {"id":"chatcmpl-abc","object":"chat.completion.chunk","created":1739200000,"model":"mix/qwen-3-235b-instruct","choices":[{"index":0,"delta":{},"finish_reason":"stop"}]}

                data: [DONE]
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_messages:
                  value:
                    error:
                      message: Invalid request: messages must be a non-empty array
                      type: invalid_request_error
                      code: invalid_request
                      param: messages
                invalid_json:
                  value:
                    error:
                      message: Invalid JSON body
                      type: invalid_request_error
                      code: invalid_json
                      param: null
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  message: Missing authorization header
                  type: authentication_error
                  code: unauthorized
                  param: null
        "500":
          description: Adapter internal error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  message: Internal server error
                  type: server_error
                  code: internal_server_error
                  param: null
        "502":
          description: Upstream API error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  message: Upstream error: mocked upstream business error
                  type: api_error
                  code: upstream_error
                  param: null
        "503":
          description: Upstream HTTP non-2xx
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  message: Upstream HTTP 503: mocked upstream failure
                  type: api_error
                  code: upstream_http_error
                  param: null
        "504":
          description: Upstream timeout
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error:
                  message: Upstream timeout
                  type: api_error
                  code: upstream_timeout
                  param: null

components:
  schemas:
    HealthResponse:
      type: object
      required: [status, service]
      properties:
        status:
          type: string
          example: ok
        service:
          type: string
          example: mix2api

    Model:
      type: object
      required: [id, object, created, owned_by]
      properties:
        id:
          type: string
        object:
          type: string
          enum: [model]
        created:
          type: integer
        owned_by:
          type: string

    ModelListResponse:
      type: object
      required: [object, data]
      properties:
        object:
          type: string
          enum: [list]
        data:
          type: array
          items:
            $ref: "#/components/schemas/Model"

    ToolDefinition:
      type: object
      required: [type, function]
      properties:
        type:
          type: string
          enum: [function]
        function:
          type: object
          required: [name]
          properties:
            name:
              type: string
            description:
              type: string
            parameters:
              type: object
              additionalProperties: true

    LegacyFunction:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        parameters:
          type: object
          additionalProperties: true

    LegacyFunctionCall:
      oneOf:
        - type: string
          enum: [auto, none, required]
        - type: object
          required: [name]
          properties:
            name:
              type: string

    ChatMessage:
      type: object
      required: [role]
      properties:
        role:
          type: string
          enum: [system, user, assistant, tool]
        content:
          oneOf:
            - type: string
            - type: "null"
            - type: array
              items:
                type: object
                additionalProperties: true
        tool_call_id:
          type: string
        tool_calls:
          type: array
          items:
            type: object
            additionalProperties: true

    ChatCompletionRequest:
      type: object
      required: [model, messages]
      properties:
        model:
          type: string
        stream:
          type: boolean
          default: false
        messages:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ChatMessage"
        tools:
          type: array
          items:
            $ref: "#/components/schemas/ToolDefinition"
        tool_choice:
          oneOf:
            - type: string
            - type: object
              additionalProperties: true
        functions:
          description: Legacy OpenAI functions input
          type: array
          items:
            $ref: "#/components/schemas/LegacyFunction"
        function_call:
          description: Legacy OpenAI function_call input
          $ref: "#/components/schemas/LegacyFunctionCall"

    ChatCompletionChoice:
      type: object
      required: [index, message, finish_reason]
      properties:
        index:
          type: integer
        message:
          type: object
          required: [role]
          properties:
            role:
              type: string
              enum: [assistant]
            content:
              oneOf:
                - type: string
                - type: "null"
            tool_calls:
              type: array
              items:
                type: object
                additionalProperties: true
        finish_reason:
          type: string
          nullable: true
          enum: [stop, tool_calls, length, content_filter, null]

    Usage:
      type: object
      required: [prompt_tokens, completion_tokens, total_tokens]
      properties:
        prompt_tokens:
          type: integer
        completion_tokens:
          type: integer
        total_tokens:
          type: integer

    ChatCompletionResponse:
      type: object
      required: [id, object, created, model, choices, usage]
      properties:
        id:
          type: string
        session_id:
          type: string
          nullable: true
        object:
          type: string
          enum: [chat.completion]
        created:
          type: integer
        model:
          type: string
        choices:
          type: array
          items:
            $ref: "#/components/schemas/ChatCompletionChoice"
        usage:
          $ref: "#/components/schemas/Usage"

    ErrorBody:
      type: object
      required: [message, type, code, param]
      properties:
        message:
          type: string
        type:
          type: string
        code:
          nullable: true
          oneOf:
            - type: string
            - type: "null"
        param:
          nullable: true
          oneOf:
            - type: string
            - type: "null"

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          $ref: "#/components/schemas/ErrorBody"
